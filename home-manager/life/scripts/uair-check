#!/usr/bin/env bash

check_file="/tmp/uair-check-stop.$USER.txt"
max_minutes=120

if [[ "$1" == "start" ]]; then
    rm -f "$check_file"
    exit 0
elif [[ "$1" == "stop" ]]; then
    # Default to max_minutes if no duration specified
    minutes=${2:-$max_minutes}
    # Cap at max_minutes maximum
    if [[ $minutes -gt $max_minutes ]]; then
        minutes=$max_minutes
    fi
    echo "$(date +%s)" > "$check_file"
    echo "$minutes" >> "$check_file"
    exit 0
fi

if [[ -f "$check_file" ]]; then
    stored_timestamp=$(head -n 1 "$check_file")
    stored_minutes=$(tail -n 1 "$check_file")

    if [[ $stored_minutes -gt $max_minutes ]]; then
        stored_minutes=$max_minutes
    fi

    current_timestamp=$(date +%s)
    time_diff=$((current_timestamp - stored_timestamp))
    duration_seconds=$((stored_minutes * 60))

    if [[ $time_diff -ge $duration_seconds ]]; then
        rm -f "$check_file"
    else
        exit 0
    fi
fi

state=$(uairctl fetch "{state}\n")

if [[ "$state" == "paused" ]]; then
    niri msg action focus-workspace task
    zenity_output=$(zenity --question \
      --title="checking in 🍅" --text \
      "noticed you might be off track, need help getting back?" \
      --extra-button="Unpause the pomo, lets do this" \
      --cancel-label="I'm wasting time, what should I do?" \
      --ok-label="My mind is cloudy, I need a meditation")
    
    zenity_exit_code=$?
    if [[ $zenity_exit_code -eq 0 ]]; then
        # ok-label: need meditation
        start-day
    elif [[ "$zenity_output" == Unpause* ]]; then
        # extra-button: unpause
        uairctl resume
    else
        # cancel-label: what should I do
        niri msg action focus-workspace task
        uairctl jump med-prep
        uairctl pause
        (
            echo "10" ; sleep 1
            echo "# Think about your main goals atm." ; sleep 3
            echo "20" ; sleep 3
            echo "30" ; sleep 3
            echo "# Are there any tasks that are missing?" ; sleep 3
            echo "40" ; sleep 3
            echo "50" ; sleep 3
            echo "# Its always good to get the easy ones out of the way first." ; sleep 3
            echo "60" ; sleep 3
            echo "70" ; sleep 3
            echo "# Urgent and Important > Urgent > Important > Neither." ; sleep 3
            echo "80" ; sleep 3
            echo "90" ; sleep 3
            echo "# Take a breath, be **conscious** to be in control." ; sleep 3
            echo "95" ; sleep 3
            echo "100" ; sleep 1
        ) | zenity \
          --progress \
          --title="what to do 🍅" \
          --percentage=0 \
          --auto-close \
          --no-cancel &> /dev/null
        uairzen ': 🌅 spend the next moment choosing what you want to accomplish next! 🧠'
    fi
fi
