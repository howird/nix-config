#!/usr/bin/env bash

check_file="/tmp/uair-check-stop.$USER.txt"
lock_file="/tmp/uair-check-lock.$USER.txt"
default_minutes=30
max_minutes=120

show_help() {
    niri msg action focus-workspace task
    uairctl jump med-prep
    uairctl pause
    (
        echo "10" ; sleep 1
        echo "# Think about your main goals atm." ; sleep 3
        echo "20" ; sleep 3
        echo "30" ; sleep 3
        echo "# Are there any tasks that are missing?" ; sleep 3
        echo "40" ; sleep 3
        echo "50" ; sleep 3
        echo "# Its always good to get the easy ones out of the way first." ; sleep 3
        echo "60" ; sleep 3
        echo "70" ; sleep 3
        echo "# Urgent and Important > Urgent > Important > Neither." ; sleep 3
        echo "80" ; sleep 3
        echo "90" ; sleep 3
        echo "# Take a breath, be **conscious** to be in control." ; sleep 3
        echo "95" ; sleep 3
        echo "100" ; sleep 1
    ) | zenity \
      --progress \
      --title="what to do ðŸ…" \
      --percentage=0 \
      --auto-close \
      --no-cancel &> /dev/null
    uairzen ': ðŸŒ… spend the next moment choosing what you want to accomplish next! ðŸ§ '
}

if [[ "$1" == "start" ]]; then
    rm -f "$check_file"
    uairctl resume
    exit 0
elif [[ "$1" == "stop" ]]; then
    # Default to max_minutes if no duration specified
    minutes=${2:-$default_minutes}
    # Cap at max_minutes maximum
    if [[ $minutes -gt $max_minutes ]]; then
        minutes=$max_minutes
    fi
    echo "$(date +%s)" > "$check_file"
    echo "$minutes" >> "$check_file"
    uairctl pause
    exit 0
elif [[ "$1" == "help" ]]; then
    show_help
    exit 0
fi

if [[ -f "$check_file" ]]; then
    stored_timestamp=$(head -n 1 "$check_file")
    stored_minutes=$(tail -n 1 "$check_file")

    if [[ $stored_minutes -gt $max_minutes ]]; then
        stored_minutes=$max_minutes
    fi

    current_timestamp=$(date +%s)
    time_diff=$((current_timestamp - stored_timestamp))
    duration_seconds=$((stored_minutes * 60))

    if [[ $time_diff -ge $duration_seconds ]]; then
        rm -f "$check_file"
    else
        exit 0
    fi
fi

state=$(uairctl fetch "{state}\n")

if [[ "$state" == "paused" ]]; then
    # Check if another instance is already running
    if [[ -f "$lock_file" ]]; then
        lock_pid=$(cat "$lock_file")
        if kill -0 "$lock_pid" 2>/dev/null; then
            # PID is still alive, another instance is running
            echo "Another instance is already running, exiting."
            exit 0
        else
            # Stale lock file from dead process, remove it
            echo "Removing stale lock file."
            rm -f "$lock_file"
        fi
    fi

    # Create lock file
    echo $$ > "$lock_file"

    # Setup cleanup trap for lock file and temp files
    cleanup() {
        rm -f "$lock_file" "$zenity_output_file" "$zenity_exit_file"
    }
    trap cleanup EXIT INT TERM

    niri msg action focus-workspace task

    # Run zenity in the background and capture its output and exit code
    zenity_output_file=$(mktemp)
    zenity_exit_file=$(mktemp)
    (zenity --question \
      --title="checking in ðŸ…" --text \
      "noticed you might be off track, need help getting back?" \
      --extra-button="Unpause the pomo, lets do this" \
      --cancel-label="I'm wasting time, what should I do?" \
      --ok-label="My mind is cloudy, I need a meditation" > "$zenity_output_file" 2>/dev/null
    echo $? > "$zenity_exit_file") &
    zenity_pid=$!

    # Wait for zenity to close, refocusing the workspace every second
    while kill -0 "$zenity_pid" 2>/dev/null; do
        niri msg action focus-workspace task
        sleep 1
    done

    # Wait for background process to complete and read results
    wait "$zenity_pid" 2>/dev/null
    zenity_output=$(cat "$zenity_output_file")
    zenity_exit_code=$(cat "$zenity_exit_file")

    if [[ $zenity_exit_code -eq 0 ]]; then
        # ok-label: need meditation
        start-day
    elif [[ "$zenity_output" == Unpause* ]]; then
        # extra-button: unpause
        uairctl resume
    else
        # cancel-label: what should I do
        show_help
    fi
fi
